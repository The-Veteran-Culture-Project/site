---
import Layout from "@/layouts/Layout.astro";
import { ResultsTable } from "@/components/admin/ResultsTable";
import { lucia } from "@/lib/auth";
import { db, desc, SurveyResponses } from 'astro:db';

// Check authentication
const sessionId = Astro.cookies.get(lucia.sessionCookieName)?.value;
if (!sessionId) {
  return Astro.redirect("/admin/login");
}

// Validate session
try {
  const session = await lucia.validateSession(sessionId);
  if (session.fresh) {
    const sessionCookie = lucia.createSessionCookie(session.id);
    Astro.cookies.set(sessionCookie.name, sessionCookie.value, sessionCookie.attributes);
  }
  if (!session.user) {
    return Astro.redirect("/admin/login");
  }
} catch (e) {
  Astro.cookies.delete(lucia.sessionCookieName, { path: "/" });
  return Astro.redirect("/admin/login");
}

// Fetch survey results from the database
const rawResults = await db.select().from(SurveyResponses)
  .orderBy(desc(SurveyResponses.created_at))
  .all();

console.log("Raw results from database:", rawResults);

// Parse the JSON strings for demographics and va_benefits
const results = rawResults.map(result => {
  // Log each raw result before processing
  console.log("Processing raw result:", result);
  console.log("Raw subscribe value:", result.subscribe, "Type:", typeof result.subscribe);
  console.log("Raw story_opt_in value:", result.story_opt_in, "Type:", typeof result.story_opt_in);
  
  // Helper function to safely parse JSON or return empty object
  const safeParseJSON = (value) => {
    if (!value) return {};
    if (typeof value === 'object') return value;
    try {
      return JSON.parse(value);
    } catch (e) {
      console.error('Error parsing JSON:', e, 'Value:', value);
      return {};
    }
  };

  // Convert boolean values explicitly
  const processed = {
    ...result,
    // Force boolean values to be true booleans
    subscribe: result.subscribe === 1 || String(result.subscribe) === "1" || String(result.subscribe) === "true",
    story_opt_in: result.story_opt_in === 1 || String(result.story_opt_in) === "1" || String(result.story_opt_in) === "true",
    demographics: safeParseJSON(result.demographics),
    va_benefits: safeParseJSON(result.va_benefits)
  };
  
  // Log the processed result
  console.log("Processed result:", processed);
  console.log("Processed subscribe:", processed.subscribe, "Type:", typeof processed.subscribe);
  console.log("Processed story_opt_in:", processed.story_opt_in, "Type:", typeof processed.story_opt_in);
  
  return processed;
});

console.log("Survey results count:", results.length);
if (results.length > 0) {
  const firstResult = results[0];
  console.log("First result ID:", firstResult.id);
  console.log("Subscribe raw value:", firstResult.subscribe);
  console.log("Subscribe type:", typeof firstResult.subscribe);
  console.log("Story opt-in raw value:", firstResult.story_opt_in);
  console.log("Story opt-in type:", typeof firstResult.story_opt_in);
  console.log("First result (if exists):", JSON.stringify(firstResult));
} else {
  console.log("No results");
}

// User is authenticated, proceed with rendering
---

<Layout title="Admin - Survey Results" isLandingPage={false}>
  <div class="container mx-auto px-4 py-8">
    <div class="max-w-7xl mx-auto">
      <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold text-white">Survey Results Admin View</h1>
        <div class="flex gap-4">
          <a href="/admin/logout" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded">
            Log out
          </a>
        </div>
      </div>
      <div class="flex justify-between items-center mb-4">
        <p class="text-white">Total results: {results.length}</p>
        <p class="text-gray-400 text-sm">Use the "Download CSV" button to export all survey data</p>
      </div>
      <ResultsTable client:load initialResults={results} />
    </div>
  </div>
</Layout>
