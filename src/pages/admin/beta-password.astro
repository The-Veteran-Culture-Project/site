---
import Layout from "@/layouts/Layout.astro";
import AdminNavigation from "@/components/admin/AdminNavigation.astro";
import { SimplifiedBetaPasswordManager } from "@/components/admin/SimplifiedBetaPasswordManager";
import { lucia } from "@/lib/auth";
import { db, SurveyUser, BetaAccessRequest } from "astro:db";
import { eq, desc } from "astro:db";

// Check if the user is logged in
const sessionId = Astro.cookies.get(lucia.sessionCookieName)?.value;
let user = null;

if (sessionId) {
  const { session, user: sessionUser } = await lucia.validateSession(sessionId);
  if (sessionUser) {
    // Verify that the user is an admin
    const adminUser = await db.select().from(SurveyUser)
      .where(eq(SurveyUser.id, sessionUser.id))
      .get();
    
    if (adminUser && adminUser.username === "admin") {
      user = sessionUser;
    }
  }
}

// If not logged in, redirect to login page
if (!user) {
  return Astro.redirect("/admin/login");
}

// Fetch beta access requests
const betaAccessRequests = await db.select().from(BetaAccessRequest)
  .orderBy(desc(BetaAccessRequest.requestedAt));

// Transform dates to strings for React component
const requestsForClient = betaAccessRequests.map(request => ({
  ...request,
  requestedAt: request.requestedAt.toISOString(),
  processedAt: request.processedAt?.toISOString(),
}));
---

<Layout title="Beta Password Management - Admin" isLandingPage={false}>
  <AdminNavigation activePage="beta-password" />
  
  <div class="container mx-auto px-4 py-8">
    <div class="max-w-2xl mx-auto">
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-white mb-2">Beta Password</h1>
        <p class="text-gray-400">Manage access to the survey during beta testing</p>
      </div>
      
      <SimplifiedBetaPasswordManager client:load accessRequests={requestsForClient} />
    </div>
  </div>
</Layout>
