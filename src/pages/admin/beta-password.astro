---
import Layout from "@/layouts/Layout.astro";
import AdminNavigation from "@/components/admin/AdminNavigation.astro";
import { BetaPasswordManager } from "@/components/admin/BetaPasswordManager";
import { BetaAccessRequestsTable } from "@/components/admin/BetaAccessRequestsTable";
import { lucia } from "@/lib/auth";
import { db, SurveyUser, BetaAccessRequest } from "astro:db";
import { eq, desc } from "astro:db";

// Check if the user is logged in
const sessionId = Astro.cookies.get(lucia.sessionCookieName)?.value;
let user = null;

if (sessionId) {
  const { session, user: sessionUser } = await lucia.validateSession(sessionId);
  if (sessionUser) {
    // Verify that the user is an admin
    const adminUser = await db.select().from(SurveyUser)
      .where(eq(SurveyUser.id, sessionUser.id))
      .get();
    
    if (adminUser && adminUser.username === "admin") {
      user = sessionUser;
    }
  }
}

// If not logged in, redirect to login page
if (!user) {
  return Astro.redirect("/admin/login");
}

// Fetch beta access requests
const betaAccessRequests = await db.select().from(BetaAccessRequest)
  .orderBy(desc(BetaAccessRequest.requestedAt));

// Transform dates to strings for React component
const requestsForClient = betaAccessRequests.map(request => ({
  ...request,
  requestedAt: request.requestedAt.toISOString(),
  processedAt: request.processedAt?.toISOString(),
}));
---

<Layout title="Beta Password Management - Admin" isLandingPage={false}>
  <div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-8">Beta Password Management</h1>
    
    <AdminNavigation activePage="beta-password" />
    
    <div class="mt-8 space-y-8">
      <div>
        <h2 class="text-2xl font-semibold mb-4">Password Settings</h2>
        <BetaPasswordManager client:load />
      </div>
      
      <div>
        <h2 class="text-2xl font-semibold mb-4">Access Requests</h2>
        <BetaAccessRequestsTable requests={requestsForClient} client:load />
      </div>
    </div>
  </div>
</Layout>
