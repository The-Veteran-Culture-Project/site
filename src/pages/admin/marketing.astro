---
import Layout from "../../layouts/Layout.astro";
import { Button } from "../../components/ui/button";
import MarketingSubscribersTable from "../../components/admin/MarketingSubscribersTable";
import { db, MarketingSubscriber } from "astro:db";

// Check if user is logged in
const user = Astro.locals.user;
if (!user) {
  return Astro.redirect("/admin/login");
}

// Fetch marketing subscribers
let subscribersData = [];
try {
  subscribersData = await db.select().from(MarketingSubscriber).orderBy(MarketingSubscriber.created_at, "desc");
  
  // Process data for the component
  subscribersData = subscribersData.map(subscriber => {
    return {
      ...subscriber,
      created_at: subscriber.created_at instanceof Date 
        ? subscriber.created_at.toISOString() 
        : subscriber.created_at
    };
  });
} catch (error) {
  console.error("Error fetching marketing subscribers:", error);
}
---

<Layout title="Marketing Subscribers | Admin">
  <div class="container mx-auto px-4 py-8">
    <div class="mb-8 flex items-center justify-between">
      <h1 class="text-2xl font-bold text-white">Marketing Subscribers</h1>
      <div class="space-x-4">
        <a href="/admin/results" class="text-blue-400 hover:text-blue-300">Survey Results</a>
        <a href="/admin/logout" class="text-red-400 hover:text-red-300">Logout</a>
      </div>
    </div>

    <div class="bg-gray-900 p-6 rounded-xl shadow-lg">
      <MarketingSubscribersTable subscribers={subscribersData} client:load />
    </div>

    <div class="mt-8 text-center">
      <a href="/admin/results" class="text-blue-500 hover:underline">Back to Survey Results</a>
    </div>
  </div>
</Layout>
