---
import Layout from "@/layouts/Layout.astro";
import { Button } from "@/components/ui/button";
import MarketingSubscribersTable from "@/components/admin/MarketingSubscribersTable";
import AdminNavigation from "@/components/admin/AdminNavigation.astro";
import { db, MarketingSubscriber } from "astro:db";

// Check if user is logged in
const user = Astro.locals.user;
if (!user) {
  return Astro.redirect("/admin/login");
}

// Fetch marketing subscribers
let subscribersData = [];
try {
  subscribersData = await db.select().from(MarketingSubscriber).orderBy(MarketingSubscriber.created_at, "desc");
  
  // Process data for the component
  subscribersData = subscribersData.map(subscriber => {
    return {
      ...subscriber,
      created_at: subscriber.created_at instanceof Date 
        ? subscriber.created_at.toISOString() 
        : subscriber.created_at
    };
  });
} catch (error) {
  console.error("Error fetching marketing subscribers:", error);
}
---

<Layout title="Marketing Subscribers | Admin">
  <AdminNavigation activePage="marketing" />

  <div class="container mx-auto px-4 pb-8">
    <div class="mb-8">
      <h1 class="text-2xl font-bold text-white">Marketing Subscribers</h1>
    </div>

    <div class="bg-gray-900 p-6 rounded-xl shadow-lg">
      <MarketingSubscribersTable subscribers={subscribersData} client:load />
    </div>

  </div>
</Layout>
