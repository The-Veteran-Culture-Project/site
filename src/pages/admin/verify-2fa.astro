---
import Layout from "@/layouts/Layout.astro";
import { db, SurveyUser } from "astro:db";
import { eq } from "astro:db";

let errorMessage: string | null = null;

// Check for temp login cookie
const tempLogin = Astro.cookies.get('temp_login');
if (!tempLogin) {
  return Astro.redirect("/admin/login");
}

let tempLoginData;
try {
  tempLoginData = JSON.parse(tempLogin.value);
  // Check if token is expired (5 minutes)
  if (Date.now() - tempLoginData.timestamp > 300000) {
    Astro.cookies.delete('temp_login');
    return Astro.redirect("/admin/login?error=expired");
  }
} catch {
  return Astro.redirect("/admin/login");
}

// Get user info for display
const user = await db.select().from(SurveyUser)
  .where(eq(SurveyUser.id, tempLoginData.userId))
  .get();

if (!user) {
  return Astro.redirect("/admin/login");
}

// Check for error in query params
const url = new URL(Astro.request.url);
if (url.searchParams.get('error') === 'invalid') {
  errorMessage = "Invalid verification code. Please try again.";
}
---

<Layout title="Two-Factor Authentication" isLandingPage={false}>
  <div class="flex min-h-screen items-center justify-center">
    <div class="w-full max-w-sm p-6 bg-gray-800 rounded-lg shadow-md">
      <h2 class="text-2xl font-bold text-white text-center mb-2">Two-Factor Authentication</h2>
      <p class="text-gray-300 text-center mb-6 text-sm">
        Enter the 6-digit code from your authenticator app
      </p>
      
      {errorMessage && (
        <div class="bg-red-500/10 border border-red-500 text-red-500 px-4 py-2 rounded mb-4">
          {errorMessage}
        </div>
      )}

      <form method="POST" action="/api/verify-2fa">
        <div class="space-y-4">
          <div>
            <label for="twoFactorCode" class="block text-sm font-medium text-gray-300 mb-2">
              Verification Code
            </label>
            <input
              type="text"
              name="twoFactorCode"
              id="twoFactorCode"
              placeholder="000000"
              maxlength="6"
              pattern="[0-9]{6}"
              autocomplete="one-time-code"
              required
              class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white text-center text-lg tracking-widest font-mono shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500/50"
            />
          </div>

          <button
            type="submit"
            class="w-full py-2 px-4 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
          >
            Verify
          </button>
          
          <div class="text-center">
            <a 
              href="/admin/login" 
              class="text-sm text-gray-400 hover:text-gray-300"
            >
              ‚Üê Back to login
            </a>
          </div>
        </div>
      </form>
    </div>
  </div>
</Layout>

<script>
  // Auto-focus the input and format as user types
  const input = document.getElementById('twoFactorCode') as HTMLInputElement;
  if (input) {
    input.focus();
    
    input.addEventListener('input', (e) => {
      const target = e.target as HTMLInputElement;
      // Only allow numbers
      target.value = target.value.replace(/[^0-9]/g, '');
      
      // Auto-submit when 6 digits are entered
      if (target.value.length === 6) {
        target.form?.requestSubmit();
      }
    });
  }
</script>
